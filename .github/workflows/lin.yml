name: Build Linux

on: push

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

env:
  QT_VERSION: 5.15.2
  BUILD_TYPE: RelWithDebInfo
  VATSIM_CLIENT_ID: ${{ secrets.VATSIM_CLIENT_ID }}
  VATSIM_CLIENT_KEY: ${{ secrets.VATSIM_CLIENT_KEY }}
  CONFIG_ENCRYPTION_KEY: ${{ secrets.CONFIG_ENCRYPTION_KEY }}
  IB_LICENSE: ${{ secrets.INSTALLBUILDER_LICENSE }}
  IB_URL: https://installbuilder.com/installbuilder-enterprise-21.9.0-linux-x64-installer.run
  IB_DiR: ../ib

jobs:

  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Install Qt
        uses: jurplel/install-qt-action@v2
        with:
            setup-python: false
            version: ${{ env.QT_VERSION }}
          
      - name: Install conan
        run: |
          python3 -m pip install --upgrade pip
          pip3 install conan
          pip3 install conan_package_tools

      - name: Initialize CMake
        run: |
          cmake -E make_directory ${{ github.workspace }}/build

      - name: Install conan packages
        working-directory: ${{ github.workspace }}/build
        run: |
          conan install ..

      - name: CMake
        working-directory: ${{ github.workspace }}/build
        run: |
          cmake .. -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DVATSIM_CLIENT_ID=${{ env.VATSIM_CLIENT_ID }} -DVATSIM_CLIENT_KEY=${{ env.VATSIM_CLIENT_KEY }} -DCONFIG_ENCRYPTION_KEY=${{ env.CONFIG_ENCRYPTION_KEY }}

      - name: Build
        working-directory: ${{ github.workspace }}/build
        run: |
          cmake --build . --config ${{ env.BUILD_TYPE }}

      - name: Install LinuxDeploy
        uses: miurahr/install-linuxdeploy-action@v1
        with:
          dir: ${{ github.workspace }}
          plugins: qt appimage
      
      - name: Create AppImage
        run: |
          mkdir -p appdir/usr/bin
          ${{ github.workspace }}/linuxdeploy-x86_64.AppImage --plugin=qt --output=appimage --create-desktop-file --executable=${{ github.workspace }}/build/bin/xPilot --appdir=appdir --icon-file=xpilot.png

      - name: Get version
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          echo "XPILOT_VERSION=$(cat xpilot.json | cat xpilot.json | jq -r '"\(.version.major).\(.version.minor).\(.version.patch)"')" >> $GITHUB_ENV

      - name: Setup InstallBuilder
        shell: bash
        run: |
          curl -L ${{ env.IB_URL }} --output ib.run
          chmod +x ib.run
          ./ib.run --mode unattended --prefix ${{ env.IB_DiR }}
          ${{ env.IB_DiR }}/bin/builder --version
          echo "$IB_LICENSE" > lic.xml
          echo "INSTALLER_SRC_PREFIX=$(pwd)" >> $GITHUB_ENV
          echo "INSTALLER_BIN_PREFIX=$XPILOT_BIN_DIR" >> $GITHUB_ENV

      - name: Create installer
        shell: bash
        run: |
          ${{ env.IB_DiR }}/bin/builder build installer/project.xml \
              --license lic.xml \
              --setvars project.outputDirectory=$(pwd) \
              --setvars project.version=${{ env.XPILOT_VERSION }}

      - uses: actions/upload-artifact@v1
        with:
          name: xPilot-${{ env.XPILOT_VERSION }}-linux-x64-installer.run
          path: xPilot-${{ env.XPILOT_VERSION }}-linux-x64-installer.run
